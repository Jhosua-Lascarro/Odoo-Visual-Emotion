---
name: CD Main Deploy & Sync

on:
  push:
    branches:
      - main

jobs:
  # Job 1: Despliegue en el servidor
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Execute Remote Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Usamos env para pasar variables al script de forma segura
          envs: PROJECT_DIR, REPO_URL
        with:
          script_stop: true # Detiene el script si un comando falla
          script: |
            PROJECT_DIR="${{ secrets.PROJECT_PATH }}"
            REPO_URL="https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git"
            
            if [ ! -d "$PROJECT_DIR/.git" ]; then
              echo "Cloning repository..."
              git clone -b main $REPO_URL $PROJECT_DIR
            fi
            
            cd $PROJECT_DIR
            echo "Updating code..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "Restarting containers..."
            # Forzamos la reconstrucción solo de lo necesario
            docker compose up -d --build --remove-orphans
            docker image prune -f

  # Job 2: Sincronización de ramas (solo si el deploy fue exitoso)
  sync:
    name: Sync Main to Develop
    runs-on: ubuntu-latest
    needs: deploy # Solo corre si el deploy salió bien
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || github.token }}

      - name: Sync Branches
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout develop
          # Usamos merge normal con estrategia para evitar conflictos de historial
          git merge origin/main -m "chore: sync develop with main [skip ci]"
          git push origin develop
