name: Lint and Format Check

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  lint-yaml:
    name: Lint YAML Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
              comments:
                min-spaces-from-content: 1

  validate-docker:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment for validation
        run: cp .env.example .env

      - name: Validate docker-compose syntax
        run: docker compose config --quiet

  validate-env-consistency:
    name: Check Env Consistency
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify variables in example
        run: |
          # Extract variables from compose
          grep -oP '\$\{[^}]+\}' docker-compose.yaml | sort -u | sed 's/[${}]//g' > compose-vars.txt
          # Extract keys from .env.example
          grep -oP '^[^#]\w+' .env.example | cut -d'=' -f1 | sort -u > env-vars.txt
          # Find missing variables
          comm -23 compose-vars.txt env-vars.txt > missing-vars.txt
          if [ -s missing-vars.txt ]; then
            echo "ERROR: Variables missing in .env.example:"
            cat missing-vars.txt
            exit 1
          fi
          echo "All variables are documented"

  validate-nginx:
    name: Validate Nginx Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test nginx configuration
        run: |
          docker run --rm \
            -v $(pwd)/config/nginx.conf:/etc/nginx/conf.d/default.conf:ro \
            nginx:alpine nginx -t
